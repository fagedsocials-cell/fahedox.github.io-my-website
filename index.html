<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Shared Pet</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6A0DAD;
            --secondary-color: #8A2BE2;
            --accent-color: #FFD700;
            --text-color: #fff;
            --bg-color: linear-gradient(135deg, #4B0082, #8A2BE2);
            --card-bg: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            transition: all 0.5s ease-in-out;
        }

        h1 {
            font-size: 2.5em;
            font-weight: 600;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .profile-screen, .pet-app, .other-profile-screen {
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden {
            display: none;
        }

        .profile-btn-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .profile-btn {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.3s, background-color 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .profile-pdp {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ccc;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--accent-color);
        }

        .profile-btn:hover:not([disabled]) {
            transform: translateY(-5px);
            background-color: var(--primary-color);
        }

        .profile-btn[disabled] {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .user-profile-display {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .user-logo-pdp {
            background-size: cover;
            background-position: center;
            font-size: 0; /* Hide emoji */
        }

        .logo {
            font-size: 1.5em;
            margin-right: 10px;
            border: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .points {
            color: var(--accent-color);
        }

        .pet-image {
            width: 200px;
            height: 200px;
            background-color: #fff;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 6em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            background-size: cover;
            background-position: center;
        }

        .stats-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .emoji {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .actions-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .action-btn:hover:not([disabled]) {
            background-color: var(--primary-color);
            transform: scale(1.05);
        }

        .action-btn[disabled] {
            background-color: #555;
            cursor: not-allowed;
        }

        .message-box {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin-top: 20px;
            font-style: italic;
            transition: all 0.5s ease-in-out;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .revert-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .revert-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .pdp-input-container {
            margin-top: 20px;
        }
        
        .file-input-label {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-input-label:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        
        .hidden-input {
            display: none;
        }
        
        .pet-selection {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pet-selection-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .pet-selection-btn:hover:not([disabled]) {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .visit-profile-container {
            margin-top: 20px;
        }
        
        .visit-profile-btn {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .visit-profile-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .other-profile-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        
        .user-id-display {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 20px;
            word-break: break-all;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <!-- Profile Selection Screen -->
        <div id="profileScreen" class="profile-screen hidden">
            <h1>Who's Playing?</h1>
            <p style="color: #ccc;">Select your profile to begin.</p>
            <div class="profile-btn-container">
                <button class="profile-btn" id="nawouraProfile" disabled>
                    <div id="nawouraProfilePdp" class="profile-pdp"></div>
                    <span>Nawoura</span>
                </button>
                <button class="profile-btn" id="fahoudProfile" disabled>
                    <div id="fahoudProfilePdp" class="profile-pdp"></div>
                    <span>Fahoud</span>
                </button>
            </div>
        </div>

        <!-- Pet App Screen -->
        <div id="petApp" class="pet-app hidden">
            <button id="backToProfilesBtn" class="revert-btn">‚¨ÖÔ∏è</button>
            
            <div class="user-profile-display">
                <span id="userLogo" class="logo"></span>
                <span id="userName"></span>: <span id="userPoints" class="points"></span> pts
            </div>

            <h1 id="petName"></h1>
            <div class="pet-image" id="petImage"></div>
            <div class="camera-btn-container">
                <label for="petCameraInput" class="camera-btn file-input-label">üì∏</label>
                <input type="file" id="petCameraInput" accept="image/*" capture="environment" class="hidden-input">
            </div>
            <div class="stats-container">
                <div class="stat">
                    <div class="emoji">‚ù§Ô∏è</div>
                    <div id="happinessStat"></div>
                </div>
                <div class="stat">
                    <div class="emoji">üçî</div>
                    <div id="hungerStat"></div>
                </div>
            </div>
            <div class="actions-container">
                <button id="petBtn" class="action-btn" disabled>Pet</button>
                <button id="feedBtn" class="action-btn" disabled>Feed</button>
                <button id="playBtn" class="action-btn" disabled>Play</button>
            </div>
            <div class="pet-selection">
                <button id="selectBlanka" class="pet-selection-btn" disabled>Blanka</button>
                <button id="selectShadow" class="pet-selection-btn" disabled>Shadow</button>
            </div>
            <div class="pdp-input-container">
                <label for="pdpFileInput" class="file-input-label">Choose Profile Picture</label>
                <input type="file" id="pdpFileInput" accept="image/*" class="hidden-input">
            </div>
            <div id="statusMessage" class="message-box hidden"></div>
            
            <div class="visit-profile-container">
                <button id="visitOtherProfileBtn" class="visit-profile-btn"></button>
            </div>
            <p class="user-id-display" id="userIdDisplay"></p>
        </div>

        <!-- Other User Profile Screen -->
        <div id="otherProfileScreen" class="other-profile-screen hidden">
            <button id="backToPetAppBtn" class="revert-btn">‚¨ÖÔ∏è</button>
            <h1 id="otherUserName"></h1>
            <div id="otherUserProfile" class="other-profile-display">
                <div id="otherUserPdp" class="profile-pdp"></div>
                <div style="font-size: 1.2rem;">
                    <span id="otherUserLogo"></span>
                    <span id="otherUserPoints"></span> pts
                </div>
            </div>
            <div id="otherProfileMessage" class="message-box hidden"></div>
        </div>

        <div id="loadingScreen" class="loading-spinner"></div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');
        
        // Firebase Setup - MANDATORY GLOBAL VARIABLES
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let petsDocRef;
        let userId;
        let activeUser;

        const PETS_DOC_ID = 'our_shared_pets';
        const PETS_COLLECTION_PATH = `artifacts/${appId}/public/data/shared_pets`;

        const petStates = {
            'Blanka': { name: "Blanka", happiness: 50, hunger: 50, emoji: 'üêà', pdp: null },
            'Shadow': { name: "Shadow", happiness: 50, hunger: 50, emoji: 'üêà‚Äç‚¨õ', pdp: null },
        };
        const defaultUserProfiles = {
            'Nawoura': { name: "Nawoura", points: 0, logo: 'üë©', pdp: null },
            'Fahoud': { name: "Fahoud", points: 0, logo: 'üë®', pdp: null },
        };
        let userProfiles = defaultUserProfiles;
        let activePetName = 'Blanka';

        const profileScreen = document.getElementById('profileScreen');
        const petApp = document.getElementById('petApp'); 
        const otherProfileScreen = document.getElementById('otherProfileScreen');
        const loadingScreen = document.getElementById('loadingScreen');
        const petNameEl = document.getElementById('petName');
        const petImageEl = document.getElementById('petImage');
        const happinessStatEl = document.getElementById('happinessStat');
        const hungerStatEl = document.getElementById('hungerStat');
        const petBtn = document.getElementById('petBtn');
        const feedBtn = document.getElementById('feedBtn');
        const playBtn = document.getElementById('playBtn');
        const statusMessageEl = document.getElementById('statusMessage');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const selectBlankaBtn = document.getElementById('selectBlanka');
        const selectShadowBtn = document.getElementById('selectShadow');
        const nawouraProfileBtn = document.getElementById('nawouraProfile');
        const fahoudProfileBtn = document.getElementById('fahoudProfile');
        const backToProfilesBtn = document.getElementById('backToProfilesBtn');
        const userNameEl = document.getElementById('userName');
        const userLogoEl = document.getElementById('userLogo');
        const userPointsEl = document.getElementById('userPoints');
        const visitOtherProfileBtn = document.getElementById('visitOtherProfileBtn');
        const otherUserLogoEl = document.getElementById('otherUserLogo');
        const pdpFileInput = document.getElementById('pdpFileInput');
        const petCameraInput = document.getElementById('petCameraInput');
        const backToPetAppBtn = document.getElementById('backToPetAppBtn');
        const otherUserNameEl = document.getElementById('otherUserName');
        const otherUserPdpEl = document.getElementById('otherUserPdp');
        const otherUserPointsEl = document.getElementById('otherUserPoints');
        const otherProfileMessageEl = document.getElementById('otherProfileMessage');
        const nawouraProfilePdpEl = document.getElementById('nawouraProfilePdp');
        const fahoudProfilePdpEl = document.getElementById('fahoudProfilePdp');
        
        const showMessage = (el, message) => {
            el.innerHTML = message;
            el.classList.remove('hidden');
            setTimeout(() => {
                el.classList.add('hidden');
            }, 3000);
        };

        const updateUI = () => {
            const pet = petStates[activePetName];
            if (pet) {
                petNameEl.textContent = pet.name;
                happinessStatEl.textContent = pet.happiness;
                hungerStatEl.textContent = pet.hunger;
                
                if (pet.pdp) {
                    petImageEl.style.backgroundImage = `url(${pet.pdp})`;
                    petImageEl.textContent = '';
                } else {
                    petImageEl.style.backgroundImage = 'none';
                    petImageEl.textContent = pet.emoji;
                }
            }

            if (activeUser && userProfiles[activeUser]) {
                const user = userProfiles[activeUser];
                userNameEl.textContent = user.name;
                userPointsEl.textContent = user.points;
                
                if (user.pdp) {
                    userLogoEl.style.backgroundImage = `url(${user.pdp})`;
                    userLogoEl.textContent = '';
                    userLogoEl.classList.add('user-logo-pdp');
                } else {
                    userLogoEl.style.backgroundImage = 'none';
                    userLogoEl.textContent = user.logo;
                    userLogoEl.classList.remove('user-logo-pdp');
                }
            }
            
            if (userProfiles['Nawoura'].pdp) {
                nawouraProfilePdpEl.style.backgroundImage = `url(${userProfiles['Nawoura'].pdp})`;
                nawouraProfilePdpEl.textContent = '';
            } else {
                 nawouraProfilePdpEl.style.backgroundImage = 'none';
                 nawouraProfilePdpEl.textContent = userProfiles['Nawoura'].logo;
            }
            if (userProfiles['Fahoud'].pdp) {
                fahoudProfilePdpEl.style.backgroundImage = `url(${userProfiles['Fahoud'].pdp})`;
                fahoudProfilePdpEl.textContent = '';
            } else {
                fahoudProfilePdpEl.style.backgroundImage = 'none';
                fahoudProfilePdpEl.textContent = userProfiles['Fahoud'].logo;
            }
            
            const otherUser = activeUser === 'Nawoura' ? 'Fahoud' : 'Nawoura';
            if (userProfiles[otherUser]) {
                visitOtherProfileBtn.textContent = `Visit ${userProfiles[otherUser].name}'s Profile`;
            }
        };
        
        const enableButtons = () => {
            petBtn.disabled = false;
            feedBtn.disabled = false;
            playBtn.disabled = false;
            selectBlankaBtn.disabled = false;
            selectShadowBtn.disabled = false;
            pdpFileInput.disabled = false;
            nawouraProfileBtn.disabled = false;
            fahoudProfileBtn.disabled = false;
        };

        const disableButtons = () => {
            petBtn.disabled = true;
            feedBtn.disabled = true;
            playBtn.disabled = true;
            selectBlankaBtn.disabled = true;
            selectShadowBtn.disabled = true;
            pdpFileInput.disabled = true;
            nawouraProfileBtn.disabled = true;
            fahoudProfileBtn.disabled = true;
        };

        const saveStateToFirestore = async (updates) => {
            if (!petsDocRef) {
                console.error("petsDocRef is not initialized.");
                showMessage(statusMessageEl, 'App is not ready. Please wait.');
                return;
            }
            try {
                await updateDoc(petsDocRef, updates);
            } catch (error) {
                console.error("Error updating state:", error);
                showMessage(statusMessageEl, 'Failed to save changes. Please try again.');
            }
        };

        const updateUserPoints = (pointsToAdd) => {
            if (activeUser && userProfiles[activeUser]) {
                const newPoints = userProfiles[activeUser].points + pointsToAdd;
                const updatedUsers = { ...userProfiles, [activeUser]: { ...userProfiles[activeUser], points: newPoints } };
                saveStateToFirestore({ users: updatedUsers });
            }
        };

        const updatePetStats = (action) => {
            let happinessChange = 0;
            let hungerChange = 0;
            let message = "";
            let pointsToAdd = 0;

            if (action === 'pet') {
                happinessChange = 10;
                message = `You petted ${activePetName}! It loves you! ‚ù§Ô∏è`;
                pointsToAdd = 5;
            } else if (action === 'feed') {
                hungerChange = -20;
                happinessChange = 5;
                message = `You fed ${activePetName}! üçî It's so full!`;
                pointsToAdd = 10;
            } else if (action === 'play') {
                happinessChange = 20;
                hungerChange = 10;
                message = `You played with ${activePetName}! It's so happy! üòä`;
                pointsToAdd = 15;
            }

            const currentPet = petStates[activePetName];
            const newHappiness = Math.min(100, currentPet.happiness + happinessChange);
            const newHunger = Math.min(100, currentPet.hunger + hungerChange);
            
            saveStateToFirestore({ [activePetName]: { ...currentPet, happiness: newHappiness, hunger: newHunger } });
            updateUserPoints(pointsToAdd);
            showMessage(statusMessageEl, message);
        };
        
        const handlePdpFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024) {
                showMessage(statusMessageEl, 'File is too large. Max size is 1MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const pdpDataUrl = e.target.result;
                const updatedUsers = { ...userProfiles, [activeUser]: { ...userProfiles[activeUser], pdp: pdpDataUrl } };
                saveStateToFirestore({ users: updatedUsers });
                showMessage(statusMessageEl, 'Profile picture saved!');
            };
            reader.readAsDataURL(file);
        };
        
        const handlePetPdpFile = (event) => {
            const file = event.target.files[0];
            if (!file) {
                console.log("No file selected.");
                return;
            }

            if (file.size > 1024 * 1024) {
                showMessage(statusMessageEl, 'File is too large. Max size is 1MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const petPdpDataUrl = e.target.result;
                const updatedPet = { ...petStates[activePetName], pdp: petPdpDataUrl };
                saveStateToFirestore({ [activePetName]: updatedPet });
                showMessage(statusMessageEl, `${petStates[activePetName].name}'s picture updated!`);
            };
            reader.readAsDataURL(file);
        };

        const showOtherProfile = (otherUser) => {
            petApp.classList.add('hidden');
            otherProfileScreen.classList.remove('hidden');
            const user = userProfiles[otherUser];
            if (user) {
                otherUserNameEl.textContent = user.name;
                otherUserPdpEl.style.backgroundImage = user.pdp ? `url(${user.pdp})` : 'none';
                otherUserPdpEl.textContent = user.pdp ? '' : user.logo;
                otherUserPdpEl.classList.toggle('user-logo-pdp', !user.pdp);
                otherUserLogoEl.textContent = user.logo;
                otherUserPointsEl.textContent = user.points;
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplayEl.textContent = `User ID: ${userId}`;
                loadingScreen.classList.add('hidden');
                profileScreen.classList.remove('hidden');
                enableButtons();

                petsDocRef = doc(db, PETS_COLLECTION_PATH, PETS_DOC_ID);
                onSnapshot(petsDocRef, async (docSnap) => {
                    try {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            petStates['Blanka'] = data['Blanka'];
                            petStates['Shadow'] = data['Shadow'];
                            userProfiles = { ...defaultUserProfiles, ...data.users };
                        } else {
                            await setDoc(petsDocRef, { Blanka: petStates.Blanka, Shadow: petStates.Shadow, users: defaultUserProfiles });
                            Object.assign(userProfiles, defaultUserProfiles);
                        }
                        updateUI();
                    } catch (error) {
                        console.error("Error in snapshot listener:", error);
                        showMessage(statusMessageEl, 'Failed to load pet data. Please refresh the page.');
                    }
                });
                
            } else {
                loadingScreen.classList.remove('hidden');
                profileScreen.classList.add('hidden');
                petApp.classList.add('hidden');
                otherProfileScreen.classList.add('hidden');
                disableButtons();

                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).catch(console.error);
                } else {
                    signInAnonymously(auth).catch(console.error);
                }
            }
        });

        nawouraProfileBtn.addEventListener('click', () => {
            activeUser = 'Nawoura';
            profileScreen.classList.add('hidden');
            petApp.classList.remove('hidden');
            updateUI();
        });

        fahoudProfileBtn.addEventListener('click', () => {
            activeUser = 'Fahoud';
            profileScreen.classList.add('hidden');
            petApp.classList.remove('hidden');
            updateUI();
        });
        
        backToProfilesBtn.addEventListener('click', () => {
            petApp.classList.add('hidden');
            profileScreen.classList.remove('hidden');
            statusMessageEl.classList.add('hidden');
        });

        visitOtherProfileBtn.addEventListener('click', () => {
            const otherUser = activeUser === 'Nawoura' ? 'Fahoud' : 'Nawoura';
            showOtherProfile(otherUser);
        });

        backToPetAppBtn.addEventListener('click', () => {
            otherProfileScreen.classList.add('hidden');
            petApp.classList.remove('hidden');
            updateUI();
        });

        petBtn.addEventListener('click', () => updatePetStats('pet'));
        feedBtn.addEventListener('click', () => updatePetStats('feed'));
        playBtn.addEventListener('click', () => updatePetStats('play'));
        pdpFileInput.addEventListener('change', handlePdpFile);
        petCameraInput.addEventListener('change', handlePetPdpFile);
        
        selectBlankaBtn.addEventListener('click', () => { activePetName = 'Blanka'; updateUI(); showMessage(statusMessageEl, 'Switched to Blanka!'); });
        selectShadowBtn.addEventListener('click', () => { activePetName = 'Shadow'; updateUI(); showMessage(statusMessageEl, 'Switched to Shadow!'); });
    </script>
</body>
</html>